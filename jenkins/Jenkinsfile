node {
    env.registry = 'http://10.0.0.20:5000'

    checkout scm

    docker.image('maven:3-jdk-11').inside('-u root -v /$HOME/.m2/:/root/.m2') {
        stage('Build') {
            sh 'mvn -B -DskipTests clean package'
        }

        //stage('Test') {
        //    sh 'mvn test'
        //}
    }

    stage('Build Image'){
        docker.withRegistry("${env.registry}") {
            dockerImage = docker.build("pi4j")
        }
    }

    stage('Push Image') {
        sh "curl ${env.registry}/v2/pi4j/tags/list"

        sh 'sudo docker buildx build --platform linux/arm/v7 -t 10.0.0.20:5000/pi4j:latest --output=type=registry,registry.insecure=true .'

        sh "curl ${env.registry}/v2/pi4j/tags/list"
    }
}

node("k3s") {

}